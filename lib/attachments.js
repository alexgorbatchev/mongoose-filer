// Generated by CoffeeScript 1.3.3
(function() {
  var EventEmitter, async, attachments, extensions, imagemagick, mkdirp,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  imagemagick = require('imagemagick');

  mkdirp = require('mkdirp');

  async = require('async');

  EventEmitter = require('events').EventEmitter;

  extensions = {
    "image/jpeg": ".jpg",
    "image/png": ".png",
    "image/gif": ".gif"
  };

  module.exports = attachments = function(config) {
    var Processor;
    return {
      Processor: Processor = (function(_super) {

        __extends(Processor, _super);

        function Processor(file, options) {
          this.file = file;
          this.options = options != null ? options : {};
          this.styles = this.options.styles || {};
          this.id = this.options.id || new Date().getTime();
          this.prefix = this.options.prefix || "default";
          this.name = this.options.name || this.file.name.replace(/(\..*?)$/, '');
          this.extension = extensions[this.file.type];
        }

        Processor.prototype.conversions = function() {
          var conversion, conversions, style;
          return conversions = (function() {
            var _ref, _results,
              _this = this;
            _ref = this.styles;
            _results = [];
            for (style in _ref) {
              conversion = _ref[style];
              _results.push((function(style, conversion) {
                var args, destFile, dir, groups, processor;
                dir = _this.dir(style);
                destFile = _this.path(style);
                args = [_this.file.path, '-resize', conversion];
                if (groups = conversion.match(/^(.*)\^$/)) {
                  args = args.concat(['-gravity', 'center', '-extent', groups[1]]);
                }
                args.push(destFile);
                processor = _this;
                return {
                  style: style,
                  path: destFile,
                  args: args,
                  convert: function(cb) {
                    return mkdirp(dir, function(err) {
                      if (err != null) {
                        return cb(err);
                      }
                      return imagemagick.convert(args, function(err) {
                        if (err != null) {
                          return cb("Imagemagick " + err);
                        }
                        processor.emit('convert', {
                          style: style,
                          file: destFile
                        });
                        return cb(null);
                      });
                    });
                  }
                };
              })(style, conversion));
            }
            return _results;
          }).call(this);
        };

        Processor.prototype.convert = function(cb) {
          var c, conversions,
            _this = this;
          conversions = this.conversions();
          return async.parallel((function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = conversions.length; _i < _len; _i++) {
              c = conversions[_i];
              _results.push(c.convert);
            }
            return _results;
          })(), function(err) {
            if (err != null) {
              _this.emit('error', err);
            }
            _this.emit('done');
            if (cb != null) {
              return cb(err);
            }
          });
        };

        Processor.prototype.dir = function(style) {
          return "" + config.storage.dir.path + "/" + this.prefix + "/" + this.id + "/" + style;
        };

        Processor.prototype.path = function(style) {
          return "" + (this.dir(style)) + "/" + this.name + this.extension;
        };

        return Processor;

      })(EventEmitter)
    };
  };

}).call(this);
